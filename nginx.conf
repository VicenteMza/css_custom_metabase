server {
    listen 80;

    # 1) Servir el CSS personalizado - LOCAL
    location /custom/ {
        alias /var/www/custom/;
    }
    
    # 2) APLICAR CSS si la URL contiene "dashboard" - PRIORIDAD ALTA
    location ~ dashboard {
        # Configurar headers del proxy
        proxy_pass http://metabase:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Desactivar compresión para que sub_filter funcione
        proxy_set_header Accept-Encoding "";
        
        # Inyectar CSS + JavaScript para control dinámico
        sub_filter '</head>' '<link rel="stylesheet" href="/custom/neon-theme.css" type="text/css"><script>
        // Activar tema solo en páginas dashboard
        if (window.location.pathname.includes("dashboard")) {
            document.body.setAttribute("data-dashboard", "true");
        } else {
            document.body.setAttribute("data-dashboard", "false");
        }
        // Reactivar al cambiar de página
        window.addEventListener("popstate", function() {
            if (window.location.pathname.includes("dashboard")) {
                document.body.setAttribute("data-dashboard", "true");
            } else {
                document.body.setAttribute("data-dashboard", "false");
            }
        });
        </script></head>';
        sub_filter_once on;
        sub_filter_types text/html;
    }
    
    # 3) Resto de rutas SIN CSS personalizado
    location / {
        # Solo proxy, sin inyección de CSS
        proxy_pass http://metabase:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
